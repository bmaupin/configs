---
- name: Run apt update to make sure Chrome repository is healthy
  command: apt update
  register: apt_update
  changed_when: false
  failed_when: false
  become: true
  tags: [chrome]

- name: Remove Chrome if repo is not enabled
  apt:
    name: google-chrome-stable
    state: absent
  become: true
  when: '"https://dl.google.com/linux/chrome/deb" not in apt_update.stdout'
  tags: [chrome]

- name: Remove Chrome if repo is broken
  apt:
    name: google-chrome-stable
    state: absent
  become: true
  when: '"GPG error: https://dl.google.com/linux/chrome/deb stable InRelease: The following signatures couldn''t be verified because the public key is not available: NO_PUBKEY" in apt_update.stderr'
  tags: [chrome]

- name: Check if Chrome is installed
  shell: dpkg -l google-chrome-stable | grep ^ii
  changed_when: no
  check_mode: no
  failed_when: no
  register: result
  tags: [chrome]

# The repo gets added by the postinstall script at /var/lib/dpkg/info/google-chrome-stable.postinst
# which creates and calls a cron job at /etc/cron.daily/google-chrome which itself reads
# values from /etc/default/google-chrome ü§¶‚Äç‚ôÇÔ∏è
- name: Make sure repo gets added if Chrome is to be installed or reinstalled
  lineinfile:
    path: /etc/default/google-chrome
    regexp: '^repo_add_once='
    line: 'repo_add_once="true"'
    create: true
  become: true
  when: result.rc is defined and result.rc != 0
  tags: [chrome]

- name: Install Google Chrome
  block:
    # TODO: This fails because of https://github.com/ansible/ansible/issues/85807
    - name: Install Google Chrome using apt
      apt:
        deb: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      become: true

  rescue:
    - name: Download Google Chrome .deb package
      get_url:
        url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        dest: /tmp/google-chrome-stable_current_amd64.deb
        mode: '0644'

    - name: Install Google Chrome from local .deb
      command: dpkg -i /tmp/google-chrome-stable_current_amd64.deb
      become: true

    - name: Remove downloaded Google Chrome .deb package
      file:
        path: /tmp/google-chrome-stable_current_amd64.deb
        state: absent
  when: result.rc is defined and result.rc != 0
  tags: [chrome]

- name: Copy Chrome .desktop file
  copy:
    src: /usr/share/applications/google-chrome.desktop
    dest: ~/.local/share/applications/google-chrome.desktop
    force: no
  tags: [chrome]

- name: Set Chrome language
  replace:
    path: ~/.local/share/applications/google-chrome.desktop
    regexp: '^Exec=.*/usr/bin/google-chrome-stable'
    replace: 'Exec=env LANGUAGE=en_CA /usr/bin/google-chrome-stable'
    backup: true
  tags: [chrome]
