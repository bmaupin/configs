---
- name: Run apt update to make sure Chrome repository is healthy
  command: apt update
  register: apt_update
  changed_when: false
  failed_when: false
  become: yes
  tags: [chrome]

- name: Remove chrome if repo is broken
  apt:
    name: google-chrome-stable
    state: absent
  become: yes
  when: '"GPG error: https://dl.google.com/linux/chrome/deb stable InRelease: The following signatures couldn''t be verified because the public key is not available: NO_PUBKEY" in apt_update.stderr'
  tags: [chrome]

- name: Check if Chrome is installed
  shell: dpkg -l google-chrome-stable | grep ^ii
  changed_when: no
  check_mode: no
  failed_when: no
  register: result
  tags: [chrome]

- name: Install Google Chrome
  apt:
    deb: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  become: yes
  when: result.rc is defined and result.rc != 0
  tags: [chrome]

- name: Copy Chrome .desktop file
  copy:
    src: /usr/share/applications/google-chrome.desktop
    dest: ~/.local/share/applications/google-chrome.desktop
    force: no
  tags: [chrome]

- name: Set Chrome language
  replace:
    path: ~/.local/share/applications/google-chrome.desktop
    regexp: '^Exec=.*/usr/bin/google-chrome-stable'
    replace: 'Exec=env LANGUAGE=en_CA /usr/bin/google-chrome-stable'
    backup: yes
  tags: [chrome]
