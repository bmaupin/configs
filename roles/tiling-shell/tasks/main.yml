---
- name: Disable Ubuntu Tiling Assistant
  shell: >
    if gsettings get org.gnome.shell disabled-extensions | grep -q tiling-assistant@ubuntu.com; then
      echo "Ubuntu Tiling Assistant already disabled"
    else
      gnome-extensions disable tiling-assistant@ubuntu.com
    fi
  register: result
  changed_when: result.stdout.find("Ubuntu Tiling Assistant already disabled") == -1
  when:
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_version is version('24.04', '=')
  tags: [tiling-shell]

- name: Install Tiling Shell extension
  shell: |
    gdbus call --session \
           --dest org.gnome.Shell.Extensions \
           --object-path /org/gnome/Shell/Extensions \
           --method org.gnome.Shell.Extensions.InstallRemoteExtension \
           "tilingshell@ferrarodomenico.com"
  args:
    creates: "{{ lookup('env', 'HOME') }}/.local/share/gnome-shell/extensions/tilingshell@ferrarodomenico.com/"
  register: extension_install
  until: extension_install.rc == 0
  retries: 5
  delay: 10
  when:
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_version is version('24.04', '=')
  tags: [tiling-shell]

- name: Configure Tiling Shell extension
  dconf:
    key: '{{ item.key }}'
    value: '{{ item.value }}'
  loop:
    - key: /org/gnome/shell/extensions/tilingshell/enable-snap-assist
      value: 'false'
    - key: /org/gnome/shell/extensions/tilingshell/inner-gaps
      value: 'uint32 0'
    - key: /org/gnome/shell/extensions/tilingshell/layouts-json
      # The '|' allows us to set a raw value, necessary because the value contains literal single and double quotes
      # The '-' ensures that the raw value doesn't contain a newline
      value: |-
        '[{"id":"Ultrawide","tiles":[{"x":0,"y":0,"width":0.375,"height":1,"groups":[1]},{"x":0.375,"y":0,"width":0.375,"height":1,"groups":[2,1]},{"x":0.75,"y":0,"width":0.250000000000002,"height":1,"groups":[2]}]},{"id":"Fullscreen","tiles":[{"x":0,"y":0,"width":1,"height":1,"groups":[]}]}]'
    - key: /org/gnome/shell/extensions/tilingshell/outer-gaps
      value: 'uint32 0'
    - key: /org/gnome/shell/extensions/tilingshell/quarter-tiling-threshold
      value: 'uint32 1'
    - key: /org/gnome/shell/extensions/tilingshell/selected-layouts
      value: "[['Ultrawide'], ['Fullscreen']]"
  when:
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_version is version('24.04', '=')
  tags: [tiling-shell]
