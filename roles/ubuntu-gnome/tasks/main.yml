---
# This is a prerequisite for the ansible dconf module
- name: Install python-psutil
  apt:
    name: python-psutil
    state: present
  become: yes
  tags: [ubuntu-gnome]

- name: Install Pop!_OS repository
  apt_repository:
    repo: ppa:system76/pop
    update_cache: yes
  become: yes
  tags: [ubuntu-gnome]

- name: Install Pop!_OS packages
  apt:
    name:
      - pop-session
      - pop-theme
      - pop-wallpapers
    state: present
  become: yes
  notify: Restart Gnome Shell
  tags: [ubuntu-gnome]

- name: Install Gnome Shell system monitor extension
  apt:
    name: gnome-shell-extension-system-monitor
    state: present
  become: yes
  tags: [ubuntu-gnome]

# This is a prerequisite for the ansible dconf module
- name: Install python-psutil
  apt:
    name: python-psutil
    state: present
  become: yes
  tags: [ubuntu-gnome]

- name: Configure Gnome Shell system monitor extension
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - { key: /org/gnome/shell/extensions/system-monitor/cpu-graph-width, value: 50 }
    - { key: /org/gnome/shell/extensions/system-monitor/cpu-show-text, value: "false" }
    - { key: /org/gnome/shell/extensions/system-monitor/disk-display, value: "true" }
    - { key: /org/gnome/shell/extensions/system-monitor/disk-graph-width, value: 50 }
    - { key: /org/gnome/shell/extensions/system-monitor/disk-show-text, value: "false" }
    - { key: /org/gnome/shell/extensions/system-monitor/icon-display, value: "false" }
    - { key: /org/gnome/shell/extensions/system-monitor/memory-graph-width, value: 50 }
    - { key: /org/gnome/shell/extensions/system-monitor/memory-show-text, value: "false" }
    - { key: /org/gnome/shell/extensions/system-monitor/net-graph-width, value: 50 }
    - { key: /org/gnome/shell/extensions/system-monitor/net-show-text, value: "false" }
    - { key: /org/gnome/shell/extensions/system-monitor/swap-display, value: "true" }
    - { key: /org/gnome/shell/extensions/system-monitor/swap-graph-width, value: 50 }
    - { key: /org/gnome/shell/extensions/system-monitor/swap-show-text, value: "false" }
  tags: [ubuntu-gnome]

- name: Disable animations
  dconf:
    key: /org/gnome/desktop/interface/enable-animations
    value: "false"
  tags: [ubuntu-gnome]

- name: Set clock format
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - { key: /org.gnome.desktop.interface/clock-format, value: "'24h'" }
    - { key: /org/gnome/desktop/interface/clock-show-date, value: "false" }
    - { key: /org/gtk/Settings/FileChooser/clock-format, value: "'24h'" }
  tags: [ubuntu-gnome]

- name: Set screen inactivity timeout
  dconf:
    key: /org/gnome/desktop/session/idle-delay
    value: "900"
  tags: [ubuntu-gnome]

- name: Show minimize button
  dconf:
    key: /org/gnome/desktop/wm/preferences/button-layout
    value: "'appmenu:minimize,close'"
  tags: [ubuntu-gnome]

- name: Hide trash icon on desktop
  dconf:
    key: /org/gnome/nautilus/desktop/trash-icon-visible
    value: "false"
  tags: [ubuntu-gnome]

- name: Enable delete in file manager
  dconf:
    key: /org/gnome/nautilus/preferences/show-delete-permanently
    value: "true"
  tags: [ubuntu-gnome]

- name: Configure night light
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - { key: /org/gnome/settings-daemon/plugins/color/night-light-schedule-automatic, value: "false" }
    - { key: /org/gnome/settings-daemon/plugins/color/night-light-schedule-to, value: 6.4999999999999982 }
    - { key: /org/gnome/settings-daemon/plugins/color/night-light-schedule-from, value: 19.0 }
    - { key: /org/gnome/settings-daemon/plugins/color/night-light-enabled, value: "true" }
  tags: [ubuntu-gnome]

- name: Set enabled extensions
  dconf:
    key: /org/gnome/shell/enabled-extensions
    value: "['donotdisturb@kylecorry31.github.io', 'system-monitor@paradoxxx.zero.gmail.com', 'ubuntu-appindicators@ubuntu.com', 'ubuntu-dock@ubuntu.com']"
  tags: [ubuntu-gnome]

# https://askubuntu.com/q/1032624/18665
- name: Fix lock screen bug
  lineinfile:
    path: /etc/sysctl.conf
    regexp: '^fs.inotify.max_user_watches=.*'
    line: fs.inotify.max_user_watches=1048576
  become: yes
  tags: [ubuntu-gnome]
